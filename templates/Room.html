<html>
<head>

 <style>
	 #dil{
	 	font-size:5vmin;
	 }
	 td{
	 	font-size:5vmin;
	 	border:0px solid;
	 	padding:5px;
	 	text-align:center;
		 background-image: linear-gradient(to top, #84C1FF	, #84C1FF	);
         background-color: darkblue;
       
	 }
     img{
        width: 100%;
        height: auto;
     }
 
	 #menber{
   	border-collapse: collapse;
   	width: 20%; 	
   	/*自動斷行*/
   	word-wrap: break-word;
   	table-layout: fixed;
   }
   .tooltips {
          position: fixed;
          padding:10px;
          background-color:white;
          border-radius:10px;
          border:3px solid;
          height:auto;
          width:10%;
          top:100px;
          left:10%;
          z-index:999999999;
          display:block;
        }
   body{
	background-image: linear-gradient(to top, #84C1FF	, #84C1FF	);

   }
   a{
	font-size: 4vmin;
   }


 </style>
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
 <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    //全域變數
    var self_select = "";
    var playerID = "";
    var alls = "";
setInterval(() => {
    console.log("test");
    
    $.ajax({
                type: "GET",
                url:  "menber",

                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    //TODO : 要透過data.userlog紀錄的每位玩家的ID值來撈取data.menber.玩家ID
                    console.log(data);
                    alls = data;
                    console.log(data.menber.length);
                    console.log(data.menber.playerID);
                    var user_log = data.userlog;
                    var imgID = document.getElementById("menber").querySelectorAll("img");
                    var checkM1 = 0;
                    var checkM2 = 0;
                    var checkM3 = 0;
                    var checkM4 = 0;
                    for(var i = 0;i < imgID.length;i++){
                        for (var key in data["menber"]) {
                            var value = data["menber"][key];
                            console.log("Key: " + key + ", Value: " + value);
                            if(value == imgID[i].id){
                                console.log("比對成功 ");

                                if(value == "M1") checkM1 = 1;
                                if(value == "M2") checkM2 = 1;
                                if(value == "M3") checkM3 = 1;
                                if(value == "M4") checkM4 = 1;

                                document.getElementById(imgID[i].id).style.opacity = 0.3;
                                document.getElementById(imgID[i].id).parentElement.style.backgroundColor = "red";
                                if(playerID == key){
                                    console.log("比對ID ")
                                    self_select = value;
                                }
                            }
                                                            
                        }// console.log(document.getElementById(data.menber[di]));   
                    }
                    
                    if(checkM1 == 0){
                        console.log("M1未選取")
                        document.getElementById("M1").style.opacity = 1;
                        document.getElementById("M1").parentElement.style.backgroundColor = "";
                    }
                    if(checkM2 == 0){
                        console.log("M2未選取")
                        document.getElementById("M2").style.opacity = 1;
                        document.getElementById("M2").parentElement.style.backgroundColor = "";
                    }
                    if(checkM3 == 0){
                        console.log("M3未選取")
                        document.getElementById("M3").style.opacity = 1;
                        document.getElementById("M3").parentElement.style.backgroundColor = "";
                    }
                    if(checkM4 == 0){
                        console.log("M4未選取")
                        document.getElementById("M4").style.opacity = 1;
                        document.getElementById("M4").parentElement.style.backgroundColor = "";
                    }
                    if(data.states == "1"){
                        window.location.href = "/";
                    }
                }
            });
}, 500);

function getUrlC(){
    //初入頁面建立
    var dt = new Date();
    // var urlParams = new URLSearchParams(window.location.search);
   
    // urlParams.set('state', playerID);
    // var newUrl = window.location.pathname + '?' + urlParams.toString();
    // window.history.pushState({}, '', newUrl);
    if (typeof(Storage) !== "undefined") {
    // 如果 localStorage 中沒有我們設定的 session
        if (!localStorage.getItem('player')) {
            // 設置一個新的 session
            playerID = "A"+dt.getTime();
            localStorage.setItem('player', playerID);
            $.ajax({
                type: "POST",
                url:  "usertime",
                data: JSON.stringify({
                        "set_time":playerID,                   
                    }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    //console.log(data.menber);             
                }
            });

        }
        // 在控制台上印出 session 的值
            console.log(localStorage.getItem('player'));
    } 
    else {
        console.log("抱歉，您的瀏覽器不支持 Web Storage...");
    }
    
    console.log("玩家ID : "+playerID)
    playerID = localStorage.getItem('player');

    var imgID = document.getElementById("menber").querySelectorAll("img");
for(var i =0;i < imgID.length;i++){
    imgID[i].addEventListener('click',function(e){
        if(this.parentElement.style.backgroundColor != "red"){
            if(self_select == ""){
            
                console.log(this.id);
                console.log("測試"+self_select)
                $.ajax({
                    type: "POST",
                    url:  "user",
                    data: JSON.stringify({
                        "user": playerID,
                        "selected": this.id,
                    
                    }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        console.log("成功");
                    },
                    error: function () {
                        // 请求失败后的处理
                        console.log("请求失败");
                    }
                });
                
            }     
        }
        else{
                if(this.id == self_select){
                this.style.opacity = 1;
                this.parentElement.style.backgroundColor = "";
                self_select = "";
                document.getElementsByClassName('tooltips')[0].style.display = "none"
                $.ajax({
                    type: "POST",
                    url:  "user",
                    data: JSON.stringify({
                        "user": playerID,                   
                    }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        console.log("成功");
                    },
                    error: function () {
                        // 请求失败后的处理
                        console.log("请求失败");
                    }
                });
                
            }
        }
        
        
        console.log(this.id);
        console.log("以選擇 : "+self_select);
    })

    document.getElementById(imgID[i].id).addEventListener('mousemove',function(event){
        if(this.parentElement.style.backgroundColor == "red"){
            var mouseX = event.clientX;
            var mouseY = event.clientY;

            document.getElementsByClassName('tooltips')[0].innerHTML = "已被選取"; 
            if(self_select == this.id){
                document.getElementsByClassName('tooltips')[0].innerHTML = "您選取的"; 
            }
            document.getElementsByClassName('tooltips')[0].style.left = mouseX + "px";
            document.getElementsByClassName('tooltips')[0].style.top = mouseY + "px";
            document.getElementsByClassName('tooltips')[0].style.display = "block"
        }else{
            this.style.opacity = 0.5;
        }              
    });
    document.getElementById(imgID[i].id).addEventListener('mouseleave',function(event){
        if(this.parentElement.style.backgroundColor == "red"){
           
            document.getElementsByClassName('tooltips')[0].style.display = "none"
        }else{
            this.style.opacity = 1;
        }              
    });
}
}

function reset_menber(){
    self_select = "";
    $.ajax({
                type: "POST",
                url:  "clear_user",
               
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    console.log("成功");
                    localStorage.removeItem('player');
                },
                error: function () {
                    // 请求失败后的处理
                    console.log("请求失败");
                }
            });
        console.log(this.id);
    location.reload();
        
}
function runGame(){
    $.ajax({
            type: "POST",
            url:  "start",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                console.log("成功");
            }
        });
    window.location.href = "/";
}
</script>
</head>
<!-- <div id="mask" style="text-align: center;width: 120%;height: 100vh;display:block;position: fixed;background-color: black;opacity: 0.7;">
    <form>
        Please Enter Your Name :

    </form>

</div> -->
<div class="tooltips" style="display:none">
    <span class="tooltiptext">Tooltip text</span>
      
  </div>
	<body onload="getUrlC()">
		<br/>
		<h1 style="text-align:center ;">AEAS 太空競賽桌遊</h1>
		<br/>
	<div class="dik">
		<table id="menber" class="nav navbar-nav" style="position:absolute;left:15%;width:70%;">
            <tr>
                <td>
                    <img id="M1" src="static/M1.png" />
                </td>
                <td>
                    <img id="M2" src="static/M2.png"/>
                </td>
                <td>
                    <img id="M3" src="static/M3.png" />
                </td>
                
            </tr>
            <tr>
                <td>
                    <img id="M4" src="static/M4.png" />
                </td>
                <td>
                    <img id="M5" src="static/M5.png" />
                </td>
                <td>
                    <img id="M6" src="static/M6.png" />
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <input type="button" class="btn btn-outline-success " value="開始" onclick="runGame()" />
                    <input type="button" class="btn btn-outline-danger" onclick="reset_menber()" value="Reset" />

                </td>
            </tr>
		</table>
		<br/>
	</div>
	<br/>
	<br/>
	<br/>
	<br/>
	</body>

</html>